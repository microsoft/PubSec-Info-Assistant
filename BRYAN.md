# Deployment notes

NOTE: This project works in GitHub Codespaces. Could not get it working on Mac or Windows but I didn't spend much time troubleshooting.

## Creating the Azure subscriptions

1. Create two subscriptions in Azure:

- Microsoft Azure Commercial subscription
- Microsoft Azure Government subscription

## Creating the instance of Azure OpenAI API

1. Request access to Azure OpenAI API:
    - <https://aka.ms/oaiapply>
    - NOTE: Azure OpenAI is only available in Microsoft Azure Commercial subscription.  Be sure to use that subscription ID in that form.

1. After Azure OpenAI request access is approved, opt out of content filtering and abuse monitoring:
    - <https://customervoice.microsoft.com/Pages/ResponsePage.aspx?id%253Dv4j5cvGGr0GRqy180BHbR7en2Ais5pxKtso_Pz4b1_xURE01NDY1OUhBRzQ3MkQxMUhZSE1ZUlJKTiQlQCN0PWcu>
    - The form expects the Application ID from the approval email from Cognitive Services Gating Support (<csgate@microsoft.com>) with subject "Welcome to the Azure OpenAI Service, YourFirstName! [ApplicationID XXXXXXXX]" where YourFirstName is your name and XXXXXXXX is the Application ID you need to enter into this form.

1. In the Microsoft Azure Commercial subscription, create an instance of Azure OpenAI <https://portal.azure.com/#create%252FMicrosoft.CognitiveServicesOpenAI>.  Ideally, the name should start with infoasst-aoai- to match the names of resources generated by this project's scripts.  Make a note of the name for use in the deployment scripts.

1. In the Microsoft Azure Commercial subscription, open the instance of Azure OpenAI and click Model deployments on the left menu.

1. Click the Manage Deployments button.  The browser will navigate to Azure AI Studio.

1. In Azure AI Studio, click Deployments on the left.

1. In the Deployments screen, click Create new deployment.

1. In the Deploy model dialog, enter the following values:

    - Select a model: gpt-35-turbo
    - Deployment name: gpt-35-turbo
    - Accept the defaults for the other settings.

1. In the Deploy model dialog, click the Create button

1. In the Microsoft Azure Commercial subscription, open the instance of Azure OpenAI and click Keys and Endpoints on the left menu.

1. Make a note of the value of key 1.  This is a secret, so keep it safe.

## Accept the terms of the "Responsible AI Notice"

If you have never accepted the terms of the "Responsible AI Notice", follow these steps.

1. In the Microsoft Azure Government subscription, create an instance of Azure Cognitive Services <https://portal.azure.us/#create%252FMicrosoft.CognitiveServicesAllInOne>.

1. On the Basics tab, select the Microsoft Azure Government subscription and enter anything else for the other values.

1. Review the "Responsible AI Notice" and check the box to acknowledge that you have read and understood the terms of the "Responsible AI Notice".

1. Click the Review + Create button.

1. After the resource has been created, you can delete it.

## Configure the deployment

1. In the scripts/environments folder, copy local.env.example to local.env.

1. Note that local.env will be ignored by git.  Since it will contain secrets, do not force git to commit the file.

1. In the local.env file, enter the following values:

    - LOCATION: usgovvirginia
    - WORKSPACE: usafcio
    - SUBSCRIPTION_ID: the ID of the Microsoft Azure Government subscription
    - USE_EXISTING_AOAI: true
    - AZURE_OPENAI_SERVICE_NAME: the name of the Azure Open AI instance you created
    - AZURE_OPENAI_SERVICE_KEY: the value of Key 1 of the Azure Open AI instance you created
    - AZURE_OPENAI_CHATGPT_DEPLOYMENT: gpt-35-turbo

## Execute the deployment

1. In the root of the project, run the following az commands:

    - az cloud set --name AzureUSGovernment
    - az login --use-device-code
      - The console will display a special url <https://microsoft.com/deviceloginus> for AzureUSGovernment and a code.  Use them to log into your Microsoft Azure Government subscription.
    - az account set --subscription "ID of your Microsoft Azure Government subscription"

1. In the root of the project, run make project.

1. Review the console for the changes the bicep files will deploy.  Press y to apply or n to cancel.

## TODO: Upload files for indexing

1. The project supports PDF, HTML and DOCX files.  I downloaded PDF files from USAF's doctrine website <https://www.doctrine.af.mil/> for testing.

1. Open your browser and navigate to the url of the web app which is <https://infoasst-web-XXXXXX.azurewebsites.us> where XXXXXX is the value in the file infra/.state/usafcio/random.txt.  This file won't exist until "make deploy" is run.

1. When the site loads, click Manage Content in the upper right-hand corner of the screen.

1. Either click to add files or drop and drop them into the rectangle.  Click the Upload button to upload the files.  You may need to scroll down to see it.

## TODO: Demo of the chat/search

## Changes I made

- app/backend/app.py - changed search_url from https://${AZURE_SEARCH_SERVICE}.search.windows.net to https://${AZURE_SEARCH_SERVICE}.search.azure.us
- app/frontend/src/pages/chat/Chat.tsx - Set Use semantic ranker for retrieval to default to false. Semantic search is not yet available in Azure Government subscriptions.
- infra/core/ai/formrecognizer.bicep - changed API version from 2023-05-01 to 2022-12-01
- infra/core/host/appservice.bicep - set days to 0 and enabled to false for all retentionPolicy elements under diagnosticLogs.  This setting is no longer supported in Azure.
- infra/core/search/search-services.bicep - changed endpoint from https://${AZURE_SEARCH_SERVICE}.search.windows.net to https://${AZURE_SEARCH_SERVICE}.search.azure.us
- infra/main.bicep - changed semanticSearch from free to disabled.  Semantic search is not yet available in Azure Government subscriptions.
- scripts/deploy-search-indexes.sh - changed search_url from https://${AZURE_SEARCH_SERVICE}.search.windows.net to https://${AZURE_SEARCH_SERVICE}.search.azure.us